<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeminiGen Automation - Step 3: Generate Images</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="styles.css?v=5.0">
    <style>
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .image-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            position: relative;
        }

        .image-card.generating {
            border-color: var(--primary-color);
        }

        .image-card.completed {
            border-color: var(--success-color);
        }

        .image-card.error {
            border-color: var(--error-color);
        }

        .image-placeholder {
            width: 100%;
            aspect-ratio: 16/9;
            background: var(--bg-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            font-size: 48px;
        }

        .image-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .image-info {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .image-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .image-actions button {
            flex: 1;
            padding: 8px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">üé¨ GeminiGen Automation</div>
        </div>
    </header>

    <!-- Step Indicator -->
    <div class="container">
        <div id="stepIndicator"></div>

        <!-- Controls Bar -->
        <div class="controls-bar">
            <div class="controls-left">
                <button id="pauseBtn" class="btn btn-secondary" disabled>
                    ‚è∏Ô∏è Pause All
                </button>
                <button id="resumeBtn" class="btn btn-primary" disabled>
                    ‚ñ∂Ô∏è Resume
                </button>
                <button id="stopBtn" class="btn btn-danger" disabled>
                    ‚èπÔ∏è Force Stop
                </button>
                <button id="restartBtn" class="btn btn-secondary" disabled>
                    üîÑ Restart
                </button>
            </div>
            <div class="controls-right">
                <button id="downloadAllBtn" class="btn btn-success">
                    üì¶ Download All Images (ZIP)
                </button>
            </div>
        </div>

        <!-- Status Info -->
        <div class="info-box">
            <h3>üìä Generation Status</h3>
            <p><strong>Status:</strong> <span id="generationStatus">Ready</span></p>
            <p><strong>Progress:</strong> <span id="progressText">0 / 0 completed</span></p>
        </div>

        <!-- Images Grid -->
        <div class="card">
            <div class="card-header">
                <h2>Generated Images</h2>
                <p>Starting and ending frames for each scene</p>
            </div>

            <div id="imagesGrid" class="images-grid"></div>
        </div>

        <!-- Navigation Buttons -->
        <div class="btn-group">
            <button id="backBtn" class="btn btn-secondary">
                ‚Üê Back to Scene Prompts
            </button>
            <button id="nextBtn" class="btn btn-primary" disabled>
                Next: Generate Videos ‚Üí
            </button>
        </div>
    </div>

    <!-- Image Settings Modal (NON-CLOSEABLE) -->
    <div id="settingsModal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h2>‚öôÔ∏è Image Generation Settings</h2>
            </div>
            <div class="modal-body">
                <!-- AI Model -->
                <div class="form-group">
                    <label class="form-label">AI Model</label>
                    <select id="aiModel" class="form-select">
                        <option value="imagen-pro">Nano Banana Pro (Free)</option>
                        <option value="imagen-4-fast">Imagen 4 Fast (1 credit/image)</option>
                        <option value="imagen-4">Imagen 4 (3 credits/image)</option>
                        <option value="imagen-4-ultra">Imagen 4 Ultra (4 credits/image)</option>
                    </select>
                </div>

                <!-- Aspect Ratio -->
                <div class="form-group">
                    <label class="form-label">Aspect Ratio</label>
                    <select id="aspectRatio" class="form-select">
                        <option value="1:1">1:1 (Square)</option>
                        <option value="16:9" selected>16:9 (Widescreen)</option>
                        <option value="9:16">9:16 (Vertical)</option>
                        <option value="4:3">4:3 (Standard)</option>
                        <option value="3:4">3:4 (Portrait)</option>
                    </select>
                </div>

                <!-- Artistic Style -->
                <div class="form-group">
                    <label class="form-label">Artistic Style</label>
                    <select id="artisticStyle" class="form-select">
                        <option value="None" selected>None</option>
                        <option value="3D Render">3D Render</option>
                        <option value="Acrylic">Acrylic</option>
                        <option value="Anime General">Anime General</option>
                        <option value="Creative">Creative</option>
                        <option value="Dynamic">Dynamic</option>
                        <option value="Fashion">Fashion</option>
                        <option value="Game Concept">Game Concept</option>
                        <option value="Graphic Design 3D">Graphic Design 3D</option>
                        <option value="Illustration">Illustration</option>
                        <option value="Photorealistic">Photorealistic</option>
                        <option value="Portrait">Portrait</option>
                        <option value="Portrait Cinematic">Portrait Cinematic</option>
                        <option value="Portrait Fashion">Portrait Fashion</option>
                        <option value="Ray Traced">Ray Traced</option>
                        <option value="Stock Photo">Stock Photo</option>
                        <option value="Watercolor">Watercolor</option>
                    </select>
                </div>

                <!-- Consistency Locks -->
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="environmentLock" checked />
                        <label for="environmentLock">
                            üåç Environment Lock - Maintain identical environment across all scenes
                        </label>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="characterLock" checked />
                        <label for="characterLock">
                            üë§ Character Consistency Lock - Keep same face, body, clothing, colors
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="startGenerationBtn" class="btn btn-primary">
                    Start Image Generation
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="state-manager.js?v=5.0"></script>
    <script src="api-handler.js?v=15.0"></script>
    <script src="common.js?v=5.0"></script>
    <script src="generation-controller.js?v=5.0"></script>
    <script src="download-manager.js?v=5.0"></script>
    <script>
        // Initialize step indicator
        document.getElementById('stepIndicator').innerHTML = Utils.createStepIndicator(3);

        // Check if user has completed page 2
        if (!StateManager.hasCompletedPage(2)) {
            Utils.showError('Please complete Step 2 first');
            setTimeout(() => Utils.navigateTo('page2.html'), 2000);
        }

        const scenes = StateManager.getScenes();
        const apiKey = StateManager.getApiKey();

        // Total image tasks = 2 per scene (start + end)
        const totalTasks = scenes.length * 2;

        // Initialize generation controller
        GenerationController.init(totalTasks);

        // Image cards storage
        const imageCards = {};

        // Create image grid
        const imagesGrid = document.getElementById('imagesGrid');

        scenes.forEach(scene => {
            // Starting frame card
            const startCard = createImageCard(scene.sceneNumber, 'start', `Scene ${scene.sceneNumber} - Starting Frame`);
            imagesGrid.appendChild(startCard);
            imageCards[`scene_${scene.sceneNumber}_start`] = startCard;

            // Ending frame card
            const endCard = createImageCard(scene.sceneNumber, 'end', `Scene ${scene.sceneNumber} - Ending Frame`);
            imagesGrid.appendChild(endCard);
            imageCards[`scene_${scene.sceneNumber}_end`] = endCard;
        });

        function createImageCard(sceneNumber, type, title) {
            const card = document.createElement('div');
            card.className = 'image-card';
            card.dataset.scene = sceneNumber;
            card.dataset.type = type;

            card.innerHTML = `
                <div class="image-info"><strong>${title}</strong></div>
                <div class="image-placeholder">
                    üñºÔ∏è
                </div>
                <div class="image-info">
                    <span class="badge badge-warning">Pending</span>
                </div>
                <div class="progress-bar" style="display: none;">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
                <div class="image-info" style="display: none;">
                    Credit Used: <strong class="credit-used">0</strong>
                </div>
                <div class="image-actions" style="display: none;">
                    <button class="btn btn-secondary download-btn">üì• Download</button>
                    <button class="btn btn-primary regenerate-btn">üîÑ Regenerate</button>
                </div>
            `;

            return card;
        }

        // Show settings modal
        const savedSettings = StateManager.getImageSettings();
        if (!savedSettings) {
            document.getElementById('settingsModal').style.display = 'flex';

            // Load saved values if any
            if (savedSettings) {
                document.getElementById('aiModel').value = savedSettings.model || 'imagen-pro';
                document.getElementById('aspectRatio').value = savedSettings.aspectRatio || '16:9';
                document.getElementById('artisticStyle').value = savedSettings.style || 'None';
                document.getElementById('environmentLock').checked = savedSettings.environmentLock !== false;
                document.getElementById('characterLock').checked = savedSettings.characterLock !== false;
            }
        }

        // Start generation button
        document.getElementById('startGenerationBtn').addEventListener('click', () => {
            const settings = {
                model: document.getElementById('aiModel').value,
                aspectRatio: document.getElementById('aspectRatio').value,
                style: document.getElementById('artisticStyle').value,
                environmentLock: document.getElementById('environmentLock').checked,
                characterLock: document.getElementById('characterLock').checked
            };

            StateManager.saveImageSettings(settings);
            document.getElementById('settingsModal').style.display = 'none';

            // Start generation
            startImageGeneration(settings);
        });

        // Start image generation
        async function startImageGeneration(settings) {
            Utils.showSuccess('Starting image generation...');

            for (const scene of scenes) {
                // Generate starting frame
                await generateImage(scene, 'start', scene.startingFrame, settings);

                // Generate ending frame
                await generateImage(scene, 'end', scene.endingFrame, settings);
            }
        }

        async function generateImage(scene, type, prompt, settings) {
            // Check if can send request
            if (!GenerationController.canSendRequest()) {
                // Add to pending tasks
                GenerationController.addPendingTask({ scene, type, prompt, settings });
                return;
            }

            const cardKey = `scene_${scene.sceneNumber}_${type}`;
            const card = imageCards[cardKey];

            // Update card UI to generating
            updateCardStatus(card, 'generating', 'Generating...', 0);

            // Call API
            const result = await APIHandler.generateImage(apiKey, prompt, settings);

            if (result.success) {
                // Track request
                GenerationController.addActiveRequest({
                    uuid: result.uuid,
                    sceneNumber: scene.sceneNumber,
                    type: type,
                    cardKey: cardKey
                });

                // Start polling for webhook updates
                pollWebhookUpdates(result.uuid, cardKey);
            } else {
                // Show error
                updateCardStatus(card, 'error', result.message, 0);
            }
        }

        function updateCardStatus(card, status, message, progress) {
            const badge = card.querySelector('.badge');
            const progressBar = card.querySelector('.progress-bar');
            const progressFill = card.querySelector('.progress-fill');

            card.className = `image-card ${status}`;

            if (status === 'generating') {
                badge.className = 'badge badge-warning';
                badge.textContent = message;
                progressBar.style.display = 'block';
                progressFill.style.width = `${progress}%`;
            } else if (status === 'completed') {
                badge.className = 'badge badge-success';
                badge.textContent = '‚úì Completed';
                progressBar.style.display = 'none';
            } else if (status === 'error') {
                badge.className = 'badge badge-error';
                badge.textContent = message;
                progressBar.style.display = 'none';
            }
        }

        // Poll webhook updates
        async function pollWebhookUpdates(uuid, cardKey) {
            const maxAttempts = 120;
            let attempt = 0;

            const pollInterval = setInterval(async () => {
                // Check if UUID is still active
                if (!GenerationController.isActiveUUID(uuid)) {
                    clearInterval(pollInterval);
                    return;
                }

                try {
                    // Poll webhook endpoint for updates
                    const response = await fetch(`/webhook-status/${uuid}`);
                    const data = await response.json();

                    if (data.status === 2) {
                        // Completed
                        clearInterval(pollInterval);
                        const card = imageCards[cardKey];
                        const placeholder = card.querySelector('.image-placeholder');
                        placeholder.innerHTML = `<img src="${data.media_url}" alt="Generated image" />`;

                        updateCardStatus(card, 'completed', 'Completed', 100);

                        // Show credit used
                        const creditElem = card.querySelector('.credit-used');
                        creditElem.textContent = data.used_credit || 0;
                        creditElem.closest('.image-info').style.display = 'block';

                        // Show actions
                        card.querySelector('.image-actions').style.display = 'flex';

                        // Mark as completed
                        GenerationController.completeRequest(uuid);

                        // Save generated image
                        saveGeneratedImage(cardKey, data.media_url);

                        // Check if all done
                        checkAllImagesCompleted();

                    } else if (data.status === 3) {
                        // Failed
                        clearInterval(pollInterval);
                        const card = imageCards[cardKey];
                        updateCardStatus(card, 'error', data.error_message || 'Generation failed', 0);
                        GenerationController.completeRequest(uuid);

                    } else if (data.status === 1) {
                        // Still processing
                        const card = imageCards[cardKey];
                        updateCardStatus(card, 'generating', `Generating... ${data.status_percentage || 0}%`, data.status_percentage || 0);
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }

                attempt++;
                if (attempt >= maxAttempts) {
                    clearInterval(pollInterval);
                    const card = imageCards[cardKey];
                    updateCardStatus(card, 'error', 'Timeout', 0);
                    GenerationController.completeRequest(uuid);
                }
            }, 3000); // Poll every 3 seconds
        }

        function saveGeneratedImage(cardKey, url) {
            const images = StateManager.getGeneratedImages();
            images[cardKey] = { url };
            StateManager.saveGeneratedImages(images);
        }

        function checkAllImagesCompleted() {
            const stats = GenerationController.getStats();
            if (stats.completed === stats.total) {
                Utils.showSuccess('All images generated!');
                document.getElementById('nextBtn').disabled = false;
            }
        }

        // Control buttons
        document.getElementById('pauseBtn').addEventListener('click', () => GenerationController.pause());
        document.getElementById('resumeBtn').addEventListener('click', () => GenerationController.resume());
        document.getElementById('stopBtn').addEventListener('click', () => GenerationController.forceStop());
        document.getElementById('restartBtn').addEventListener('click', () => GenerationController.restart());

        // Download all button
        document.getElementById('downloadAllBtn').addEventListener('click', () => {
            const images = StateManager.getGeneratedImages();
            DownloadManager.downloadAllImagesAsZIP(images);
        });

        // Navigation
        document.getElementById('backBtn').addEventListener('click', () => Utils.navigateTo('page2.html'));
        document.getElementById('nextBtn').addEventListener('click', () => Utils.navigateTo('page4.html'));

        // Resume handler
        window.onGenerationResume = async () => {
            while (GenerationController.hasPendingTasks() && GenerationController.canSendRequest()) {
                const task = GenerationController.getNextPendingTask();
                await generateImage(task.scene, task.type, task.prompt, task.settings);
            }
        };

        // Restart handler
        window.onGenerationRestart = () => {
            const settings = StateManager.getImageSettings();
            startImageGeneration(settings);
        };
    </script>
</body>
</html>
